name: NeuralOS CI/CD

on:
  push:
    branches: [ main, master, develop, "release/*" ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Nightly full build + benchmark at 02:00 UTC
    - cron: '0 2 * * *'

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CMAKE_BUILD_TYPE: Release
  NEURAOS_VERSION: "5.0.0"

jobs:
  #
  # Build Matrix - Multiple profiles
  #
  build-and-test:
    name: Build (${{ matrix.profile }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        profile: [minimal, drone, full]
        include:
          - profile: minimal
            cmake_flags: >-
              -DBUILD_MAVLINK=OFF -DBUILD_SWARM=OFF -DBUILD_OFFBOARD=OFF
              -DBUILD_SENSORS=OFF -DBUILD_CAMERA=OFF -DBUILD_POWER=OFF -DBUILD_OTA=OFF
          - profile: drone
            cmake_flags: >-
              -DBUILD_MAVLINK=ON -DBUILD_SWARM=ON -DBUILD_OFFBOARD=ON
              -DBUILD_SENSORS=ON -DBUILD_CAMERA=ON -DBUILD_NETWORK=ON
              -DBUILD_SECURITY=ON -DBUILD_POWER=ON -DBUILD_OTA=ON
          - profile: full
            cmake_flags: >-
              -DBUILD_MAVLINK=ON -DBUILD_SWARM=ON -DBUILD_OFFBOARD=ON
              -DBUILD_SENSORS=ON -DBUILD_CAMERA=ON -DBUILD_NETWORK=ON
              -DBUILD_SECURITY=ON -DBUILD_POWER=ON -DBUILD_OTA=ON
              -DBUILD_TOOLS=ON -DBUILD_EXAMPLES=ON

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake build-essential \
            libpthread-stubs0-dev

      - name: Configure (${{ matrix.profile }})
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DBUILD_TESTS=ON \
            ${{ matrix.cmake_flags }}

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure --timeout 120

      - name: Upload build artifacts
        if: matrix.profile == 'full'
        uses: actions/upload-artifact@v4
        with:
          name: neuraos-build-${{ matrix.profile }}-${{ github.sha }}
          path: |
            build/lib*.so
            build/lib*.a
            build/bin/
          retention-days: 7

  #
  # Code Quality
  #
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck

      - name: Check code formatting (changed files)
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch --no-tags --depth=1 origin "${{ github.base_ref }}"
            files=$(git diff --name-only "origin/${{ github.base_ref }}"...HEAD -- \
              'src/**/*.c' 'src/**/*.cpp' 'src/**/*.h' \
              'tests/**/*.c' 'tests/**/*.cpp' 'tests/**/*.h' | tr '\n' ' ')
          else
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              base_ref="HEAD~1"
            else
              git fetch --no-tags --depth=1 origin "${{ github.ref_name }}" || true
              base_ref="$(git rev-parse HEAD)"
            fi
            files=$(git diff --name-only "$base_ref" -- \
              'src/**/*.c' 'src/**/*.cpp' 'src/**/*.h' \
              'tests/**/*.c' 'tests/**/*.cpp' 'tests/**/*.h' | tr '\n' ' ')
          fi
          if [ -n "${files:-}" ]; then
            echo "Checking formatting for: $files"
            echo "$files" | xargs -n 1 clang-format --dry-run --Werror
          else
            echo "No changed C/C++ source files to lint."
          fi

      - name: Static analysis (cppcheck)
        run: |
          cppcheck --enable=warning,performance,portability \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            -I src -I src/npie/api \
            --std=c17 \
            src/ || true

  #
  # Security scan
  #
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run CodeQL analysis
        uses: github/codeql-action/init@v3
        with:
          languages: cpp

      - name: Build for CodeQL
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=OFF
          cmake --build build --parallel $(nproc)

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v3

  #
  # Nightly AI benchmark
  #
  nightly-benchmark:
    name: Nightly AI Benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: build-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Build with benchmarks
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=ON \
            -DENABLE_PROFILING=ON
          cmake --build build --parallel $(nproc)

      - name: Run benchmarks
        run: |
          ctest --test-dir build -R benchmark --output-on-failure --timeout 300

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: build/benchmark_results/
          retention-days: 30

  #
  # Fallback Makefile build
  #
  fallback-make:
    name: Build (Makefile.simple)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build (Makefile.simple)
        run: make -f Makefile.simple all

      - name: Test (Makefile.simple)
        run: make -f Makefile.simple test

  #
  # Weekly PX4 SITL integration test
  #
  px4-sitl-test:
    name: PX4 SITL Integration
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: build-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential docker.io

      - name: Build drone profile
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_MAVLINK=ON \
            -DBUILD_SWARM=ON \
            -DBUILD_OFFBOARD=ON \
            -DBUILD_SENSORS=ON \
            -DBUILD_TESTS=ON
          cmake --build build --parallel $(nproc)

      - name: Run MAVLink unit tests
        run: ctest --test-dir build -R mavlink --output-on-failure --timeout 120

      - name: Run Swarm unit tests
        run: ctest --test-dir build -R swarm --output-on-failure --timeout 120
